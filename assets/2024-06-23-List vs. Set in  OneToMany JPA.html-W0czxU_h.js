import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as s,o as a,a as t}from"./app-B6py68zA.js";const p={},e=t('<h1 id="spring-jpa中-onetomany关系中的list与set对比-baeldung" tabindex="-1"><a class="header-anchor" href="#spring-jpa中-onetomany关系中的list与set对比-baeldung"><span>Spring JPA中@OneToMany关系中的List与Set对比 | Baeldung</span></a></h1><p>Spring JPA和Hibernate为与数据库的无缝通信提供了强大的工具。然而，随着客户端将更多的控制权委托给框架，包括查询生成，结果可能远非我们所期望的。</p><p>通常在to-many关系中使用_Lists_还是_Sets_存在混淆。<strong>这种混淆通常因为Hibernate为其bags、lists和sets使用相似的名称，但背后的含义略有不同而被放大。</strong></p><p>在大多数情况下，_Sets_更适合_one-to-many_或_many-to-many_关系。<strong>然而，它们有特定的性能影响，我们应该意识到这一点。</strong></p><p>在本教程中，我们将学习在实体关系上下文中_Lists_和_Sets_的区别，并回顾几个不同复杂度的示例。我们还将确定每种方法的优缺点。</p><h2 id="_2-测试" tabindex="-1"><a class="header-anchor" href="#_2-测试"><span>2. 测试</span></a></h2><p>我们将使用专用库来测试请求的数量。<strong>检查日志不是一个好的解决方案，因为它不是自动化的，可能只适用于简单的例子。</strong> 当请求生成数十甚至数百个查询时，使用日志是不够高效的。</p><p>首先，我们需要_io.hypersistence_。请注意，artifact ID中的数字是Hibernate版本号：</p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code>``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>``\n    ``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>``io.hypersistence``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>``\n    ``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>``hypersistence-utils-hibernate-63``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>``\n    ``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>``3.7.0``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>``\n``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>``\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此外，我们将使用util库进行日志分析：</p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code>``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>``\n    ``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>``com.vladmihalcea``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>``\n    ``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>``db-util``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>``\n    ``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>``1.0.7``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>``\n``<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>``\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以使用这些库进行探索性测试，覆盖我们应用程序的关键部分。<strong>这样，我们确保实体类的更改不会在查询生成中产生一些看不见的副作用。</strong></p><p>我们应该用提供的实用工具包装我们的DataSource以使其工作。我们可以使用BeanPostProcessor来做到这一点：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceWrapper</span> <span class="token keyword">implements</span> <span class="token class-name">BeanPostProcessor</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">DataSource</span> originalDataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">ChainListener</span> listener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">SLF4JQueryLoggingListener</span> loggingListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SLF4JQueryLoggingListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            loggingListener<span class="token punctuation">.</span><span class="token function">setQueryLogEntryCreator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InlineQueryLogEntryCreator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            listener<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>loggingListener<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            listener<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DataSourceQueryCountListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> <span class="token class-name">ProxyDataSourceBuilder</span>\n              <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>originalDataSource<span class="token punctuation">)</span>\n              <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;datasource-proxy&quot;</span><span class="token punctuation">)</span>\n              <span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>\n              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其余的就很简单了。在我们的测试中，我们将使用_SQLStatementCountValidator_来验证查询的数量和类型。</p><h2 id="_3-领域模型" tabindex="-1"><a class="header-anchor" href="#_3-领域模型"><span>3. 领域模型</span></a></h2><p>为了使示例更加相关和易于理解，我们将使用一个社交网络网站的模型。我们将有不同组、用户、帖子和评论之间的关系。</p><p>然而，我们将逐步增加复杂性，添加实体以突出差异和性能影响。<strong>这很重要，因为只有少数关系的简单模型无法提供完整的画面。</strong> 同时，过于复杂的模型可能会压倒性地提供信息，使其难以跟随。</p><p>对于这些示例，我们将只使用to-many关系的_eager fetch type_。<strong>通常，当我们使用lazy fetch时，_Lists_和_Sets_表现相似。</strong></p><p>在视觉上，我们将使用_Iterable_作为to-many字段类型。这只是为了简洁，所以我们不需要为_Lists_和_Sets_重复相同的视觉。我们将在每个部分明确定义专用类型，并在代码中显示。</p><h2 id="_4-用户和帖子" tabindex="-1"><a class="header-anchor" href="#_4-用户和帖子"><span>4. 用户和帖子</span></a></h2><p>首先，让我们只考虑我们领域的这一部分。在这里，我们将只考虑用户和帖子：</p><h3 id="_4-1-lists-和-sets-连接" tabindex="-1"><a class="header-anchor" href="#_4-1-lists-和-sets-连接"><span>4.1. _Lists_和_Sets_连接</span></a></h3><p>让我们来检查一下当我们只请求一个用户时查询的行为。我们将考虑_Set_和_List_的以下两种场景：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>\n<span class="token annotation punctuation">@Entity</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 其他字段</span>\n    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>cascade <span class="token operator">=</span> <span class="token class-name">CascadeType</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">,</span> mappedBy <span class="token operator">=</span> <span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span> fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>\n    <span class="token keyword">protected</span> <span class="token class-name">List</span>``<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span>`` posts<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>基于_Set_的_User_看起来非常相似：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>\n<span class="token annotation punctuation">@Entity</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 其他字段</span>\n    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>cascade <span class="token operator">=</span> <span class="token class-name">CascadeType</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">,</span> mappedBy <span class="token operator">=</span> <span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span> fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>\n    <span class="token keyword">protected</span> <span class="token class-name">Set</span>``<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span>`` posts<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>在获取_User_时，Hibernate会生成一个单一的查询，使用LEFT JOIN一次性获取所有信息。</strong> 对于这两种情况都是如此：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> u<span class="token punctuation">.</span>email<span class="token punctuation">,</span> u<span class="token punctuation">.</span>username<span class="token punctuation">,</span> p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>author_id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>content\n<span class="token keyword">FROM</span> simple_user u\n         <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> post p <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> p<span class="token punctuation">.</span>author_id\n<span class="token keyword">WHERE</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> ?\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>虽然我们只有一个查询，但用户的数据将为每一行重复。<strong>这意味着我们将看到ID、电子邮件和用户名多次出现，就像特定用户有多少帖子一样：</strong></p><table><thead><tr><th>u.id</th><th>u.email</th><th>u.username</th><th>p.id</th><th>p.author_id</th><th>p.content</th></tr></thead><tbody><tr><td>101</td><td>user101@email.com</td><td>user101</td><td>1</td><td>101</td><td>“User101 post 1”</td></tr><tr><td>101</td><td>user101@email.com</td><td>user101</td><td>2</td><td>101</td><td>“User101 post 2”</td></tr><tr><td>102</td><td>user102@email.com</td><td>user102</td><td>3</td><td>102</td><td>“User102 post 1”</td></tr><tr><td>102</td><td>user102@email.com</td><td>user102</td><td>4</td><td>102</td><td>“User102 post 2”</td></tr><tr><td>103</td><td>user103@email.com</td><td>user103</td><td>5</td><td>103</td><td>“User103 post 1”</td></tr><tr><td>103</td><td>user103@email.com</td><td>user103</td><td>6</td><td>103</td><td>“User103 post 2”</td></tr></tbody></table><p>如果用户表有很多列或帖子，这可能会造成性能问题。我们可以通过显式指定获取模式来解决这个问题。</p><h3 id="_4-2-lists-和-sets-n-1" tabindex="-1"><a class="header-anchor" href="#_4-2-lists-和-sets-n-1"><span>4.2. <em>Lists_和_Sets</em> N+1</span></a></h3><p>同时，在获取多个用户时，我们遇到了一个臭名昭著的N+1问题。这对于基于_List_的_Users_是真实的：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>\n<span class="token keyword">void</span> <span class="token function">givenEagerListBasedUser_WhenFetchingAllUsers_ThenIssueNPlusOneRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">List</span>````````<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span>```````` users <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">assertSelectCount</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于基于_Set_的_Users_也是如此：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>\n<span class="token keyword">void</span> <span class="token function">givenEagerSetBasedUser_WhenFetchingAllUsers_ThenIssueNPlusOneRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">List</span>````````<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span>```````` users <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">assertSelectCount</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将只有两种类型的查询。第一个查询获取所有用户：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> u<span class="token punctuation">.</span>email<span class="token punctuation">,</span> u<span class="token punctuation">.</span>username\n<span class="token keyword">FROM</span> simple_user u\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>和N个后续请求，为每个_User_获取帖子：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>author_id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>content\n<span class="token keyword">FROM</span> post p\n<span class="token keyword">WHERE</span> p<span class="token punctuation">.</span>author_id <span class="token operator">=</span> ?\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因此，对于这些类型的关系，_Lists_和_Sets_之间没有任何差异。</p><h2 id="_5-组、用户和帖子" tabindex="-1"><a class="header-anchor" href="#_5-组、用户和帖子"><span>5. 组、用户和帖子</span></a></h2><p>让我们考虑更复杂的关系，并将组添加到我们的模型中。它们与用户创建单向_many-to-many_关系：</p><h3 id="_5-1-lists-和-n-1" tabindex="-1"><a class="header-anchor" href="#_5-1-lists-和-n-1"><span>5.1. <em>Lists_和_N</em>+1</span></a></h3><p>我们将有以下带有@_ManyToMany_关系的_Group_类：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>\n<span class="token annotation punctuation">@Entity</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Group</span> <span class="token punctuation">{</span>\n    <span class="token annotation punctuation">@Id</span>\n    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>\n    <span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>\n    <span class="token keyword">private</span> <span class="token class-name">List</span>````````<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span>```````` members<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>让我们尝试获取所有组：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>\n<span class="token keyword">void</span> <span class="token function">givenEagerListBasedGroup_whenFetchingAllGroups_thenIssueNPlusMPlusOneRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">List</span>```<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Group</span><span class="token punctuation">&gt;</span></span>``` groups <span class="token operator">=</span> groupService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">Set</span>````````<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span>```````` users <span class="token operator">=</span> groups<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Group</span><span class="token operator">::</span><span class="token function">getMembers</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">::</span><span class="token function">stream</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">assertSelectCount</span><span class="token punctuation">(</span>groups<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> users<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Hibernate将为每个组发出额外的查询以获取成员，以及为每个成员获取他们的帖子。因此，我们将有三种类型的查询：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> g<span class="token punctuation">.</span>id<span class="token punctuation">,</span> g<span class="token punctuation">.</span>name\n<span class="token keyword">FROM</span> interest_group g\n\n<span class="token keyword">SELECT</span> gm<span class="token punctuation">.</span>interest_group_id<span class="token punctuation">,</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> u<span class="token punctuation">.</span>email<span class="token punctuation">,</span> u<span class="token punctuation">.</span>username\n<span class="token keyword">FROM</span> interest_group_members gm\n         <span class="token keyword">JOIN</span> simple_user u <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> gm<span class="token punctuation">.</span>members_id\n<span class="token keyword">WHERE</span> gm<span class="token punctuation">.</span>interest_group_id <span class="token operator">=</span> ?\n\n<span class="token keyword">SELECT</span> p<span class="token punctuation">.</span>author_id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>content\n<span class="token keyword">FROM</span> post p\n<span class="token keyword">WHERE</span> p<span class="token punctuation">.</span>author_id <span class="token operator">=</span> ?\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>总的来说，我们将得到1 + N + M数量的请求。</strong> N是组的数量，M是这些组中唯一用户的数量。让我们尝试获取一个单一的组：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@ParameterizedTest</span>\n<span class="token annotation punctuation">@ValueSource</span><span class="token punctuation">(</span>longs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">void</span> <span class="token function">givenEagerListBasedGroup_whenFetchingAllGroups_thenIssueNPlusOneRequests</span><span class="token punctuation">(</span><span class="token class-name">Long</span> groupId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">Optional</span>```<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Group</span><span class="token punctuation">&gt;</span></span>``` group <span class="token operator">=</span>service<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">assertThat</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">assertSelectCount</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> group<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们将有类似的情况，但我们将使用_LEFT JOIN_在单个查询中获取所有_User_数据。因此，将只有两种类型的查询：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> g<span class="token punctuation">.</span>id<span class="token punctuation">,</span> gm<span class="token punctuation">.</span>interest_group_id<span class="token punctuation">,</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> u<span class="token punctuation">.</span>email<span class="token punctuation">,</span> u<span class="token punctuation">.</span>username<span class="token punctuation">,</span> g<span class="token punctuation">.</span>name\n<span class="token keyword">FROM</span> interest_group g\n         <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>interest_group_members gm <span class="token keyword">JOIN</span> simple_user u <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> gm<span class="token punctuation">.</span>members_id<span class="token punctuation">)</span>\n                   <span class="token keyword">ON</span> g<span class="token punctuation">.</span>id <span class="token operator">=</span> gm<span class="token punctuation">.</span>interest_group_id\n<span class="token keyword">WHERE</span> g<span class="token punctuation">.</span>id <span class="token operator">=</span> ?\n\n<span class="token keyword">SELECT</span> p<span class="token punctuation">.</span>author_id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>content\n<span class="token keyword">FROM</span> post p\n<span class="token keyword">WHERE</span> p<span class="token punctuation">.</span>author_id <span class="token operator">=</span> ?\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>总的来说，我们将有N + 1个请求，其中N是组内成员的数量。</strong></p><h3 id="_5-2-sets-和笛卡尔积" tabindex="-1"><a class="header-anchor" href="#_5-2-sets-和笛卡尔积"><span>5.2. _Sets_和笛卡尔积</span></a></h3><p>使用_Sets_时，我们将看到不同的情况。让我们检查一下基于_Set_的_Group_类：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>\n<span class="token annotation punctuation">@Entity</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Group</span> <span class="token punctuation">{</span>\n    <span class="token annotation punctuation">@Id</span>\n    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>\n    <span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>\n    <span class="token keyword">private</span> <span class="token class-name">Set</span>````````<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span>```````` members<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>获取所有组将产生与基于_List_的组略有不同的结果：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>\n<span class="token keyword">void</span> <span class="token function">givenEagerSetBasedGroup_whenFetchingAllGroups_thenIssueNPlusOneRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">List</span>```<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Group</span><span class="token punctuation">&gt;</span></span>``` groups <span class="token operator">=</span> groupService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">assertSelectCount</span><span class="token punctuation">(</span>groups<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>与前一个例子中的_N + M +_ 1不同。<strong>我们将只有_N_ + 1，但会得到更复杂的查询。</strong> 我们仍然有一个单独的查询来获取所有组，但是Hibernate使用两个JOIN在一个查询中获取用户及其帖子：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> g<span class="token punctuation">.</span>id<span class="token punctuation">,</span> g<span class="token punctuation">.</span>name\n<span class="token keyword">FROM</span> interest_group g\n\n<span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span>\n       u<span class="token punctuation">.</span>username<span class="token punctuation">,</span>\n       u<span class="token punctuation">.</span>email<span class="token punctuation">,</span>\n       p<span class="token punctuation">.</span>id<span class="token punctuation">,</span>\n       p<span class="token punctuation">.</span>author_id<span class="token punctuation">,</span>\n       p<span class="token punctuation">.</span>content<span class="token punctuation">,</span>\n       gm<span class="token punctuation">.</span>interest_group_id\n<span class="token keyword">FROM</span> interest_group_members gm\n         <span class="token keyword">JOIN</span> simple_user u <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> gm<span class="token punctuation">.</span>members_id\n         <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> post p <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> p<span class="token punctuation">.</span>author_id\n<span class="token keyword">WHERE</span> gm<span class="token punctuation">.</span>interest_group_id <span class="token operator">=</span> ?\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>尽管我们减少了查询数量，但由于JOINs，结果集可能包含重复数据，随后是笛卡尔积。<strong>我们将为组中的所有用户获取重复的组信息，所有这些将为每个用户帖子重复：</strong></p><table><thead><tr><th>u.id</th><th>u.username</th><th>u.email</th><th>p.id</th><th>p.author_id</th><th>p.content</th><th>gm.interest_group_id</th></tr></thead><tbody><tr><td>301</td><td>user301</td><td>user301@email.com</td><td>201</td><td>301</td><td>“User301’s post 1”</td><td>101</td></tr><tr><td>302</td><td>user302</td><td>user302@email.com</td><td>202</td><td>302</td><td>“User302’s post 1”</td><td>101</td></tr><tr><td>303</td><td>user303</td><td>user303@email.com</td><td>NULL</td><td>NULL</td><td>NULL</td><td>101</td></tr><tr><td>304</td><td>user304</td><td>user304@email.com</td><td>203</td><td>304</td><td>“User304’s post 1”</td><td>102</td></tr><tr><td>305</td><td>user305</td><td>user305@email.com</td><td>204</td><td>305</td><td>“User305’s post 1”</td><td>102</td></tr><tr><td>306</td><td>user306</td><td>user306@email.com</td><td>NULL</td><td>NULL</td><td>NULL</td><td>102</td></tr><tr><td>307</td><td>user307</td><td>user307@email.com</td><td>205</td><td>307</td><td>“User307’s post 1”</td><td>103</td></tr><tr><td>308</td><td>user308</td><td>user308@email.com</td><td>206</td><td>308</td><td>“User308’s post 1”</td><td>103</td></tr><tr><td>309</td><td>user309</td><td>user309@email.com</td><td>NULL</td><td>NULL</td><td>NULL</td><td>103</td></tr></tbody></table><p>回顾前面的查询，很明显为什么获取一个单一的组会发出一个单一的请求：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@ParameterizedTest</span>\n<span class="token annotation punctuation">@ValueSource</span><span class="token punctuation">(</span>longs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">void</span> <span class="token function">givenEagerSetBasedGroup_whenFetchingAllGroups_thenCreateCartesianProductInOneQuery</span><span class="token punctuation">(</span><span class="token class-name">Long</span> groupId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    groupService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">assertSelectCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们将只使用第二个带有JOINs的查询，减少了请求数量：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span>\n       u<span class="token punctuation">.</span>username<span class="token punctuation">,</span>\n       u<span class="token punctuation">.</span>email<span class="token punctuation">,</span>\n       p<span class="token punctuation">.</span>id<span class="token punctuation">,</span>\n       p<span class="token punctuation">.</span>author_id<span class="token punctuation">,</span>\n       p<span class="token punctuation">.</span>content<span class="token punctuation">,</span>\n       gm<span class="token punctuation">.</span>interest_group_id\n<span class="token keyword">FROM</span> interest_group_members gm\n         <span class="token keyword">JOIN</span> simple_user u <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> gm<span class="token punctuation">.</span>members_id\n         <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> post p <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> p<span class="token punctuation">.</span>author_id\n<span class="token keyword">WHERE</span> gm<span class="token punctuation">.</span>interest_group_id <span class="token operator">=</span> ?\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-使用-lists-和-sets-进行删除" tabindex="-1"><a class="header-anchor" href="#_5-3-使用-lists-和-sets-进行删除"><span>5.3. 使用_Lists_和_Sets_进行删除</span></a></h3><p>_Sets_和_Lists_之间的另一个有趣差异是它们如何删除对象。<strong>这只适用于@_ManyToMany_关系。</strong> 让我们首先考虑_Sets_的更简单情况：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@ParameterizedTest</span>\n<span class="token annotation punctuation">@ValueSource</span><span class="token punctuation">(</span>longs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">void</span> <span class="token function">givenEagerListBasedGroup_whenRemoveUser_thenIssueOnlyOneDelete</span><span class="token punctuation">(</span><span class="token class-name">Long</span> groupId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    groupService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>group <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Set</span>````````<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span>```````` members <span class="token operator">=</span> group<span class="token punctuation">.</span><span class="token function">getMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>members<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">Set</span>````````<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span>```````` newMembers <span class="token operator">=</span> members<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            group<span class="token punctuation">.</span><span class="token function">setMembers</span><span class="token punctuation">(</span>newMembers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            groupService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">assertSelectCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">assertDeleteCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>行为非常合理，我们只是从连接表中删除记录。我们在日志中只会看到两个查询：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> g<span class="token punctuation">.</span>id<span class="token punctuation">,</span> g<span class="token punctuation">.</span>name<span class="token punctuation">,</span>\n       u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> u<span class="token punctuation">.</span>username<span class="token punctuation">,</span> u<span class="token punctuation">.</span>email<span class="token punctuation">,</span>\n       p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>author_id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>content<span class="token punctuation">,</span>\n       m<span class="token punctuation">.</span>interest_group_id\n<span class="token keyword">FROM</span> interest_group g\n         <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>interest_group_members m <span class="token keyword">JOIN</span> simple_user u <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> m<span class="token punctuation">.</span>members_id<span class="token punctuation">)</span>\n                   <span class="token keyword">ON</span> g<span class="token punctuation">.</span>id <span class="token operator">=</span> m<span class="token punctuation">.</span>interest_group_id\n         <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> post p <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> p<span class="token punctuation">.</span>author_id\n\n<span class="token keyword">DELETE</span>\n<span class="token keyword">FROM</span> interest_group_members\n<span class="token keyword">WHERE</span> interest_group_id <span class="token operator">=</span> ? <span class="token operator">AND</span> members_id <span class="token operator">=</span> ?\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>我们有一个额外的选择，只是因为测试方法不是事务性的，原始组没有存储在我们的持久化上下文中。</strong></p><p>总的来说，_Sets_的行为正如我们所假设的。现在，让我们检查_Lists_的行为：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@ParameterizedTest</span>\n<span class="token annotation punctuation">@ValueSource</span><span class="token punctuation">(</span>longs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">void</span> <span class="token function">givenEagerListBasedGroup_whenRemoveUser_thenIssueRecreateGroup</span><span class="token punctuation">(</span><span class="token class-name">Long</span> groupId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    groupService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>group <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n        <span class="token class-name">List</span>````````<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span>```````` members <span class="token operator">=</span> group<span class="token punctuation">.</span><span class="token function">getMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">int</span> originalNumberOfMembers <span class="token operator">=</span> members<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">assertSelectCount</span><span class="token punctuation">(</span><span class="token constant">ONE</span> <span class="token operator">+</span> originalNumberOfMembers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>members<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            members<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            groupService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">assertSelectCount</span><span class="token punctuation">(</span><span class="token constant">ONE</span> <span class="token operator">+</span> originalNumberOfMembers<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">assertDeleteCount</span><span class="token punctuation">(</span><span class="token constant">ONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">assertInsertCount</span><span class="token punctuation">(</span>originalNumberOfMembers <span class="token operator">-</span> <span class="token constant">ONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这里，我们有几个查询：SELECT、DELETE和INSERT。<strong>问题是Hibernate从连接表中删除整个组，并重新创建它。</strong> 再次，由于测试方法中没有持久化上下文，我们有初始选择语句：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> u<span class="token punctuation">.</span>email<span class="token punctuation">,</span> u<span class="token punctuation">.</span>username<span class="token punctuation">,</span> g<span class="token punctuation">.</span>name<span class="token punctuation">,</span>\n       g<span class="token punctuation">.</span>id<span class="token punctuation">,</span> gm<span class="token punctuation">.</span>interest_group_id\n<span class="token keyword">FROM</span> interest_group g\n         <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>interest_group_members gm <span class="token keyword">JOIN</span> simple_user u <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> gm<span class="token punctuation">.</span>members_id<span class="token punctuation">)</span>\n                   <span class="token keyword">ON</span> g<span class="token punctuation">.</span>id <span class="token operator">=</span> gm<span class="token punctuation">.</span>interest_group_id\n<span class="token keyword">WHERE</span> g<span class="token punctuation">.</span>id <span class="token operator">=</span> ?\n\n<span class="token keyword">SELECT</span> p<span class="token punctuation">.</span>author_id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>content\n<span class="token keyword">FROM</span> post p\n<span class="token keyword">WHERE</span> p<span class="token punctuation">.</span>author_id <span class="token operator">=</span> ?\n\n<span class="token keyword">DELETE</span>\n<span class="token keyword">FROM</span> interest_group_members\n<span class="token keyword">WHERE</span> interest_group_id <span class="token operator">=</span> ?\n\n<span class="token keyword">INSERT</span>\n<span class="token keyword">INTO</span> interest_group_members <span class="token punctuation">(</span>interest_group_id<span class="token punctuation">,</span> members_id<span class="token punctuation">)</span>\n<span class="token keyword">VALUES</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码将产生一个查询以获取所有组成员。_N_个请求获取成员的帖子，其中_N_是成员的数量。一个请求删除整个组，以及N - 1个请求再次添加成员。<strong>总的来说，我们可以认为它是1 + 2N。</strong></p><p>_Lists_不会产生笛卡尔积，不是因为性能考虑。<strong>由于_Lists_允许重复元素，Hibernate在区分笛卡尔重复项和集合中的重复项时存在问题。</strong></p><p><strong>这就是为什么建议仅在@<em>ManyToMany_注解中使用_Sets</em>。</strong> 否则，我们应该为剧烈的性能影响做好准备。</p><h2 id="_6-完整领域模型" tabindex="-1"><a class="header-anchor" href="#_6-完整领域模型"><span>6. 完整领域模型</span></a></h2><p>现在，让我们考虑一个更现实的领域，其中包含许多不同的关系：</p><h3 id="_6-1-lists" tabindex="-1"><a class="header-anchor" href="#_6-1-lists"><span>6.1. <em>Lists</em></span></a></h3><p>首先，让我们考虑所有to-many关系中使用_List_的情况。让我们尝试从数据库中获取所有用户：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@ParameterizedTest</span>\n<span class="token annotation punctuation">@MethodSource</span>\n<span class="token keyword">void</span> <span class="token function">givenEagerListBasedUser_WhenFetchingAllUsers_ThenIssueNPlusOneRequests</span><span class="token punctuation">(</span><span class="token class-name">ToIntFunction</span><span class="token operator">&lt;</span><span class="token class-name">List</span>````````<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span>````````<span class="token operator">&gt;</span> function<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">int</span> numberOfRequests <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">countNumberOfRequestsWithFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">assertSelectCount</span><span class="token punctuation">(</span>numberOfRequests<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">static</span> <span class="token class-name">Stream</span>`<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Arguments</span><span class="token punctuation">&gt;</span></span>` <span class="token function">givenEagerListBasedUser_WhenFetchingAllUsers_ThenIssueNPlusOneRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>\n        <span class="token class-name">Arguments</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ToIntFunction</span><span class="token operator">&lt;</span><span class="token class-name">List</span>````````<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span>````````<span class="token operator">&gt;</span><span class="token punctuation">)</span> s <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n            <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> s<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\n            <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Post</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',87),o=[e];function c(l,i){return a(),s("div",null,o)}const d=n(p,[["render",c],["__file","2024-06-23-List vs. Set in  OneToMany JPA.html.vue"]]),k=JSON.parse('{"path":"/posts/baeldung/2024-06-23/2024-06-23-List%20vs.%20Set%20in%20%20OneToMany%20JPA.html","title":"Spring JPA中@OneToMany关系中的List与Set对比 | Baeldung","lang":"zh-CN","frontmatter":{"date":"2024-06-24T00:00:00.000Z","category":["Spring JPA","Hibernate"],"tag":["List vs. Set","OneToMany"],"head":[["meta",{"name":"keywords","content":"Spring JPA, Hibernate, OneToMany, List, Set"}],["meta",{"property":"og:url","content":"https://www.kahen.xyz/posts/baeldung/2024-06-23/2024-06-23-List%20vs.%20Set%20in%20%20OneToMany%20JPA.html"}],["meta",{"property":"og:site_name","content":"Baeldung 中文网"}],["meta",{"property":"og:title","content":"Spring JPA中@OneToMany关系中的List与Set对比 | Baeldung"}],["meta",{"property":"og:description","content":"Spring JPA中@OneToMany关系中的List与Set对比 | Baeldung Spring JPA和Hibernate为与数据库的无缝通信提供了强大的工具。然而，随着客户端将更多的控制权委托给框架，包括查询生成，结果可能远非我们所期望的。 通常在to-many关系中使用_Lists_还是_Sets_存在混淆。这种混淆通常因为Hibern..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-06-23T16:35:30.000Z"}],["meta",{"property":"article:author","content":"Kahen"}],["meta",{"property":"article:tag","content":"List vs. Set"}],["meta",{"property":"article:tag","content":"OneToMany"}],["meta",{"property":"article:published_time","content":"2024-06-24T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-06-23T16:35:30.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Spring JPA中@OneToMany关系中的List与Set对比 | Baeldung\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2024-06-24T00:00:00.000Z\\",\\"dateModified\\":\\"2024-06-23T16:35:30.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Kahen\\",\\"url\\":\\"https://www.kahen.xyz\\"}]}"]],"description":"Spring JPA中@OneToMany关系中的List与Set对比 | Baeldung Spring JPA和Hibernate为与数据库的无缝通信提供了强大的工具。然而，随着客户端将更多的控制权委托给框架，包括查询生成，结果可能远非我们所期望的。 通常在to-many关系中使用_Lists_还是_Sets_存在混淆。这种混淆通常因为Hibern..."},"headers":[{"level":2,"title":"2. 测试","slug":"_2-测试","link":"#_2-测试","children":[]},{"level":2,"title":"3. 领域模型","slug":"_3-领域模型","link":"#_3-领域模型","children":[]},{"level":2,"title":"4. 用户和帖子","slug":"_4-用户和帖子","link":"#_4-用户和帖子","children":[{"level":3,"title":"4.1. _Lists_和_Sets_连接","slug":"_4-1-lists-和-sets-连接","link":"#_4-1-lists-和-sets-连接","children":[]},{"level":3,"title":"4.2. Lists_和_Sets N+1","slug":"_4-2-lists-和-sets-n-1","link":"#_4-2-lists-和-sets-n-1","children":[]}]},{"level":2,"title":"5. 组、用户和帖子","slug":"_5-组、用户和帖子","link":"#_5-组、用户和帖子","children":[{"level":3,"title":"5.1. Lists_和_N+1","slug":"_5-1-lists-和-n-1","link":"#_5-1-lists-和-n-1","children":[]},{"level":3,"title":"5.2. _Sets_和笛卡尔积","slug":"_5-2-sets-和笛卡尔积","link":"#_5-2-sets-和笛卡尔积","children":[]},{"level":3,"title":"5.3. 使用_Lists_和_Sets_进行删除","slug":"_5-3-使用-lists-和-sets-进行删除","link":"#_5-3-使用-lists-和-sets-进行删除","children":[]}]},{"level":2,"title":"6. 完整领域模型","slug":"_6-完整领域模型","link":"#_6-完整领域模型","children":[{"level":3,"title":"6.1. Lists","slug":"_6-1-lists","link":"#_6-1-lists","children":[]}]}],"git":{"createdTime":1719160530000,"updatedTime":1719160530000,"contributors":[{"name":"Kahen","email":"Kahen@users.noreply.github.com","commits":1}]},"readingTime":{"minutes":9.31,"words":2794},"filePathRelative":"posts/baeldung/2024-06-23/2024-06-23-List vs. Set in  OneToMany JPA.md","localizedDate":"2024年6月24日","excerpt":"\\n<p>Spring JPA和Hibernate为与数据库的无缝通信提供了强大的工具。然而，随着客户端将更多的控制权委托给框架，包括查询生成，结果可能远非我们所期望的。</p>\\n<p>通常在to-many关系中使用_Lists_还是_Sets_存在混淆。<strong>这种混淆通常因为Hibernate为其bags、lists和sets使用相似的名称，但背后的含义略有不同而被放大。</strong></p>\\n<p>在大多数情况下，_Sets_更适合_one-to-many_或_many-to-many_关系。<strong>然而，它们有特定的性能影响，我们应该意识到这一点。</strong></p>","autoDesc":true}');export{d as comp,k as data};
